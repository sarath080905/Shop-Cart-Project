{% extends 'shop/layout/main.html' %}
{% block title %}
{{ product.name }} | Shop Cart
{% endblock title %}

{% block content %}
<style>
/* ================== PRODUCT DETAILS PAGE STYLING ================== */

/* Product Image Box */
.pic-box {
    position: relative;
    overflow: hidden;
    border-radius: 16px;
    border: 2px solid #c8e6c9; /* soft mint border */
    background: linear-gradient(135deg, #e8f5e9, #fffde7); /* fresh green → warm yellow */
    box-shadow: 0 6px 18px rgba(56, 142, 60, 0.25); /* subtle green glow */
    transition: transform 0.35s ease, box-shadow 0.35s ease;
}
.pic-box:hover {
    transform: scale(1.03);
    box-shadow: 0 14px 28px rgba(255, 193, 7, 0.35); /* golden glow */
}
.pic-box img {
    width: 100%;
    height: 380px;
    object-fit: cover;
    border-radius: 14px;
    transition: transform 0.4s ease-in-out;
}
.pic-box:hover img {
    transform: scale(1.08);
}

/* Badge */
.hot {
    position: absolute;
    top: 15px;
    left: 15px;
    background: linear-gradient(45deg, #2e7d32, #66bb6a); /* rich green */
    color: #fff;
    padding: 6px 14px;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
}

/* Breadcrumb */
.breadcrumb {
    background-color: transparent;
    padding: 0;
}
.breadcrumb a {
    color: #388e3c; /* medium green links */
    text-decoration: none;
    font-weight: 500;
}
.breadcrumb a:hover {
    color: #fbc02d; /* golden yellow on hover */
}
.breadcrumb .active {
    color: #fbc02d; /* active golden */
    font-weight: 600;
}

/* Feedback messages */
.feedback-message {
    font-weight: 500;
    margin-top: 10px;
}
.feedback-message.success {
    color: #2e7d32;
}
.feedback-message.error {
    color: #d32f2f;
}

/* Responsive */
@media (max-width: 768px) {
    .pic-box img {
        height: 260px;
    }
}

</style>

<section class="my-5 py-5 w-100 h-100">
  <div class="container">

    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb hover-color-green fs-6">
    <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
    <li class="breadcrumb-item"><a href="{% url 'collections' %}">Collections</a></li>
    <li class="breadcrumb-item"><a href="{% url 'collection_view' product.category.name %}">{{ product.category.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
  </ol>
</nav>
    <hr class="mb-2 color-success">

    <!-- Product Card -->
    <div class="row g-4 align-items-center">

      <!-- Product Image -->
      <div class="col-md-5">
        <div class="pic-box">
          {% if product.trending %}
          <span class="hot">Hot</span>
          {% endif %}
          <img src="{{ product.image_or_url }}" alt="{{ product.name }}">
        </div>
      </div>

      <!-- Product Info -->
      <div class="col-md-7">
        <div class="card border-0 shadow-sm p-4 rounded-4">
          <h2 class="fw-bold text-success mb-3">{{ product.name }}</h2>
          <p class="text-muted mb-4">{{ product.description|default:"No description available." }}</p>

          <!-- Pricing -->
          <div class="mb-4">
            {% if product.original_price %}
            <span class="text-decoration-line-through text-secondary fs-5 me-3">₹{{ product.original_price }}</span>
            {% endif %}
            <span class="text-warning fw-bold fs-3">₹{{ product.selling_price }}</span>
          </div>

          <!-- Quantity and Actions -->
          {% if product.quantity > 0 %}
          <form id="addToCartForm" method="post">
            {% csrf_token %}
            <input type="hidden" value="{{ product.id }}" name="product_id">

            <div class="d-flex align-items-center mb-3">
              <button type="button" id="minusBtn" class="btn btn-outline-success btn-sm"><i class="fa fa-minus"></i></button>
              <input type="text" name="qty" id="qtyInput" value="1" class="form-control text-center mx-2" style="width: 70px;">
              <button type="button" id="plusBtn" class="btn btn-outline-success btn-sm"><i class="fa fa-plus"></i></button>
            </div>

            <div class="d-flex gap-3">
              <button type="button" id="addToCartBtn" class="btn btn-success btn-lg">
                <i class="fa fa-cart-plus me-2"></i> Add to Cart
              </button>
              <button type="button" class="btn btn-warning btn-lg text-dark fw-bold">
                <i class="fa fa-heart me-2"></i> Favorite
              </button>
            </div>
          </form>
          {% else %}
          <button class="btn btn-secondary btn-lg" disabled>Out of Stock</button>
          {% endif %}

          <!-- Feedback -->
          <div id="feedbackMessage" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const addToCartBtn = document.getElementById("addToCartBtn");
    const addToFavBtn = document.querySelector(".btn-warning");
    const feedbackMessage = document.getElementById("feedbackMessage");
    const qtyInput = document.getElementById("qtyInput");

    // ===== Feedback handler =====
    function showFeedback(message, isSuccess) {
        feedbackMessage.textContent = message;
        feedbackMessage.className = `feedback-message ${isSuccess ? 'success' : 'error'}`;
        setTimeout(() => {
            feedbackMessage.textContent = "";
            feedbackMessage.className = "feedback-message";
        }, 3000);
    }

    // ===== Get CSRF token =====
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ===== Send Request =====
    function sendRequest(url, data, successCallback) {
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "login_required") {
                window.location.href = "{% url 'login' %}";
            } else if (data.status === "success") {
                successCallback(data);
            } else {
                showFeedback(data.message || "Something went wrong.", false);
            }
        })
        .catch(() => {
            showFeedback("An error occurred. Please try again.", false);
        });
    }

    // ===== Add to Cart =====
    if (addToCartBtn) {
        addToCartBtn.addEventListener("click", function () {
            let quantity = parseInt(qtyInput.value);
            if (isNaN(quantity) || quantity < 1) {
                quantity = 1; // fallback to 1
            }

            sendRequest("{% url 'add_to_cart' %}", {
                product_id: "{{ product.id }}",
                quantity: quantity
            }, data => {
                showFeedback(data.message, true);
            });
        });
    }

    // ===== Add to Favorites =====
    if (addToFavBtn) {
        addToFavBtn.addEventListener("click", function () {
            sendRequest("{% url 'add_to_favorites' %}", {
                product_id: "{{ product.id }}"
            }, data => {
                showFeedback(data.message, true);
                addToFavBtn.innerHTML = '<i class="fa fa-heart"></i> Added';
                addToFavBtn.disabled = true;
            });
        });
    }

    // ===== Quantity Buttons =====
    const minusBtn = document.getElementById("minusBtn");
    const plusBtn = document.getElementById("plusBtn");

    if (minusBtn && plusBtn && qtyInput) {
        minusBtn.addEventListener("click", () => {
            let currentQty = parseInt(qtyInput.value) || 1;
            if (currentQty > 1) qtyInput.value = currentQty - 1;
        });
        plusBtn.addEventListener("click", () => {
            let currentQty = parseInt(qtyInput.value) || 1;
            qtyInput.value = currentQty + 1;
        });
    }
});
</script>

{% endblock %}
